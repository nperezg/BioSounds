<div class="modal fade" id="modal-div" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel">Edit password</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="passwordForm">
					<input name="itemID" type="hidden" value="{{ userId }}">
					<div class="form-group" id="admin_pwd_group">						
						<label for="admin_pwd">Administrator Password</label>		
						<input id="admin_pwd" name="admin_pwd" class="form-control" type="password" required>
						<div class="invalid-feedback">
							Please provide the correct administrator password.
						</div>
					</div> 	
					<div class="form-group" id="new_password1">
						<label for="user_new_pwd1">New Password</label>		
						<input id="user_new_pwd1" name="password_password" class="form-control" type="password" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" required>
						<div class="invalid-feedback">
							Please provide a valid password.
						</div>
						<small id="passwordHelpBlock" class="form-text text-muted">
							Min 8 characters long, 1 uppercase letter and 1 number. Special characters allowed.
						</small>
					</div>
					<div class="form-group" id="new_password2">	
						<label for="user_new_pwd2">Confirm Password</label>
						<input id="user_new_pwd2" class="form-control" type="password" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" required>
						<div class="invalid-feedback">
							Passwords do not match.
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button id="saveButton" type="button" class="btn btn-outline-primary"><i class="fas fa-save"></i> Save</button>
			</div>
		</div>
	</div>
</div>

<script>
	$(function(){
		'use strict';

		$('#saveButton').click(function(){
			$('#passwordForm').submit();
		});

		document.querySelectorAll('[type=password]').forEach(function(elem) {
			elem.addEventListener('keyup', function() {
				document.getElementById('user_new_pwd2').setCustomValidity('');
				if ($('#user_new_pwd2').val() !== $('#user_new_pwd1').val()) {
					document.getElementById('user_new_pwd2').setCustomValidity('Passwords do not match.');
				}
			});
		});

		$('#passwordForm').submit(function(e) {
			if (this.checkValidity() === false) {
				e.stopPropagation();
			} else {
				$.ajax({
					type: 'post',
					url: '{{ baseUrl }}/admin/users/save',
					data: $(this).serialize(),
				})
					.done(function(response) {
						showAlert(JSON.parse(response).message);
						$('#modal-div').modal('hide');
					})
					.fail(function(response) {
						let responseJson = JSON.parse(response.responseText);
						if (responseJson.errorCode === 1) {
							$('#passwordForm').removeClass('was-validated');
							$('#admin_pwd').addClass('is-invalid');
						}
					});
			}

			this.classList.add('was-validated');
			e.preventDefault();
		});
	});
</script>
